<% layout("layouts/boilerplate") %>

<style>
.wishlist-btn {
  font-size: 1rem;
  transition: all 0.2s ease-in-out;
  border: 1.5px solid #fe424d;
  color: #fe424d;
  background-color: transparent;
}

.wishlist-btn i {
  margin-right: 6px;
}

/* Active state: filled heart and background */
.wishlist-btn.active {
  background-color: #fe424d;
  color: white;
}

/* Add pop animation on click */
.wishlist-btn:active {
  transform: scale(1.1);
}

span {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

span:hover {
  background-color: #e5e7eb;
  border-radius: 50%;
}

#edit-btn {
  width: 72px;
}
</style>

<div id="show">
  <div class="col-8 offset-3">
    <h3 id="show-title"><%= listing.title %></h3>
  </div>

  <div class="card col-6 offset-3 listing-card" style="width: 32rem;">
    <img class="card-img-top" src="<%= listing.image.url %>" alt="Image not found" id="show-img" />
    <div class="card-body">
      <br />

      <div class="d-flex justify-content-between align-items-center" id="listing-detail">
        <p class="mb-0">Owned by <i><%= listing.owner.username %></i></p>

        <!-- Book Button -->
        <button
          id="book-btn"
          class="btn px-4 py-2 <%= isBooked ? 'btn-success disabled' : 'btn-dark' %> ms-auto me-2"
          onclick="openBookingModal()"
        >
          <%= isBooked ? 'Booked' : 'Book' %>
        </button>

        <!-- Overlay Modal -->
        <div id="bookingModal" style="display: none;">
          <div
            style="
              position: fixed;
              top: 0;
              left: 0;
              width: 100vw;
              height: 100vh;
              background-color: rgba(0, 0, 0, 0.5);
              display: flex;
              justify-content: center;
              align-items: center;
              z-index: 999;
            "
          >
            <!-- Modal Content -->
            <div
              style="
                background-color: #f8f9fa;
                padding: 1.5rem;
                border-radius: 8px;
                width: 90%;
                max-width: 400px;
                position: relative;
              "
            >
              <!-- Close Button -->
              <span
                onclick="closeBookingModal()"
                style="
                  position: absolute;
                  top: 10px;
                  right: 15px;
                  font-size: 24px;
                  cursor: pointer;
                  color: #ff1515;
                "
                >&times;</span
              >

              <!-- Booking Form -->
              <form id="bookingForm" novalidate>
                <label for="datePicker">Select your stay dates</label>
                <br /><br />
                <input
                  type="text"
                  name="dateRange"
                  id="datePicker"
                  placeholder="Select date range"
                  required
                  class="form-control"
                />
                <br />

                <label for="guests" class="form-label">No of Guests</label>
                <input
                  id="guests"
                  name="guests"
                  type="number"
                  min="1"
                  value="1"
                  class="form-control"
                  required
                />
                <br />
                <button type="submit" class="btn btn-primary" id="reserveBtn">
                  Reserve Dates
                </button>
              </form>
            </div>
          </div>
        </div>

        <!-- Save/Wishlist btn -->
        <form action="/listings/<%= listing._id %>/wishlists" method="POST" class="wishlist-form">
          <button
            type="submit" id="wishlist-btn"
            class="btn wishlist-btn px-4 py-2
              <%= currUser && currUser.wishlist.includes(listing._id) ? 'active' : 'btn-outline-danger' %>"
          >
            <i
              class="fa-<%= currUser && currUser.wishlist.includes(listing._id) ? 'solid' : 'regular' %> fa-heart"
            ></i>
            <%= currUser && currUser.wishlist.includes(listing._id) ? 'Saved' : 'Save' %>
          </button>
        </form>
      </div>

      <ul>
        <li>Category: <%= listing.category %></li>
        <li><%= listing.description %></li>
        <li>Price: &#8377; <%= listing.price.toLocaleString('en-IN') %>/night</li>
        <li>Location: <%= listing.location %></li>
        <li>Country: <%= listing.country %></li>
      </ul>
    </div>
  </div>

  <% if (currUser && currUser._id.equals(listing.owner._id)) { %>
  <!-- Protect edit/delete routes via middleware -->

  <div class="btns mb-5" style="display: flex;">
    <a href="/listings/<%= listing._id %>/edit" class="btn btn-dark offset-3" id="edit-btn">Edit</a>

    <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE">
      <button class="btn btn-dark col-12 offset-5">Delete</button>
    </form>
  </div>
  <% } %>

  <div class="col-8 offset-3 mb-3 mt-3" id="review-section">
    <% if (currUser) { %>
    <hr />
    <h4>Leave a Review</h4>

    <form
      action="/listings/<%= listing._id %>/reviews"
      method="POST"
      novalidate
      class="needs-validation"
    >
      <div class="mb-3 mt-3">
        <label for="rating" class="form-label">Rating</label>
        <fieldset class="starability-slot">
          <input
            type="radio"
            id="no-rate"
            class="input-no-rate"
            name="review[rating]"
            value="1"
            checked
            aria-label="No rating."
          />
          <input type="radio" id="first-rate1" name="review[rating]" value="1" />
          <label for="first-rate1" title="Terrible">1 star</label>
          <input type="radio" id="first-rate2" name="review[rating]" value="2" />
          <label for="first-rate2" title="Not good">2 stars</label>
          <input type="radio" id="first-rate3" name="review[rating]" value="3" />
          <label for="first-rate3" title="Average">3 stars</label>
          <input type="radio" id="first-rate4" name="review[rating]" value="4" />
          <label for="first-rate4" title="Very good">4 stars</label>
          <input type="radio" id="first-rate5" name="review[rating]" value="5" />
          <label for="first-rate5" title="Amazing">5 stars</label>
        </fieldset>
      </div>

      <div class="mb-3 mt-3">
        <label for="comment" class="form-label">Comments</label>
        <textarea
          id="comment"
          name="review[comment]"
          cols="20"
          rows="5"
          class="form-control"
          placeholder="Share your experience"
          required
        ></textarea>
        <div class="invalid-feedback">Please add some comments for review</div>
      </div>

      <button class="btn btn-outline-dark">Submit</button>
    </form>
    <% } %>

    <!-- Reviews -->
    <% if (listing.reviews.length > 0) { %>
    <hr />
    <h4>All Reviews</h4>

    <div class="row" id="comments">
      <% for (review of listing.reviews) { %>
      <div class="card col-12 col-md-5 ms-md-3 mb-3">
        <div class="card-body">
          <h5 class="card-title">@<%= review.author.username %></h5>

          <p class="starability-result card-text" data-rating="<%= review.rating %>"></p>

          <p class="card-text"><%= review.comment %></p>
        </div>

        <% if (currUser && currUser._id.equals(review.author._id)) { %>
        <form
          class="mb-3"
          method="POST"
          action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
        >
          <button class="btn btn-sm btn-dark mt-3">Delete</button>
        </form>
        <% } %>
      </div>
      <% } %>
    </div>
    <% } %>
  </div>
</div>




<script>
  function openBookingModal() {
    document.getElementById("bookingModal").style.display = "block";

    if (!window.datePickerInitialized) {
      flatpickr("#datePicker", {
        mode: "range",
        dateFormat: "d-m-Y",
        minDate: "today"
      });
      window.datePickerInitialized = true;
    }
  }

  function closeBookingModal() {
    document.getElementById("bookingModal").style.display = "none";
  }

  const isOwner = <%= listing.owner.equals(currUser?._id) ? true : false %>;

  document.getElementById("reserveBtn").addEventListener("click", async function (e) {
    e.preventDefault();

    if (isOwner) {
      alert("You cannot book your own listing.");
      return;
    }

    const dateRange = document.getElementById("datePicker").value;
    const [startDate, endDate] = dateRange.split("to").map(date => date.trim());
    const start = new Date(startDate.split('-').reverse().join('-'));
    const end = new Date(endDate.split('-').reverse().join('-'));
    const diffTime = Math.abs(end - start);
    const diffDays = diffTime / (1000 * 60 * 60 * 24);

    const guests = parseInt(document.getElementById("guests").value);
    const pricePerGuest = Number("<%= listing.price %>");
    const total = diffDays * guests * pricePerGuest * 100;
    const listingId = "<%= listing._id %>";

    const res = await fetch(`/listings/${listingId}/book`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      body: JSON.stringify({
        guests,
        amount: total,
        checkInDate: start,
        checkOutDate: end
      })
    });

    if (res.status === 401) {
      const data = await res.json();
      alert(data.error);
      window.location.href = "/login";
      return;
    }

    const data = await res.json();

    const options = {
      key: "<%= razorpayKey %>",
      amount: data.amount,
      currency: "INR",
      name: "Booking Payment",
      description: `Booking for ${guests} guest(s)`,
      order_id: data.id,
      handler: function (response) {
        fetch("/listings/verify-payment", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            razorpay_order_id: response.razorpay_order_id,
            razorpay_payment_id: response.razorpay_payment_id,
            razorpay_signature: response.razorpay_signature,
            listingId: listingId,
            guests: guests,
            startDate: start,
            endDate: end
          })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert("Payment Successful!");
            window.location.href = `/booked-trips`;
          } else {
            alert("Payment Verification Failed");
          }
        });
      },
      theme: { color: "#3399cc" }
    };

    const rzp = new Razorpay(options);
    rzp.open();
  });

  const isLoggedIn = <%= currUser ? true : false %>;

  document.querySelectorAll('.wishlist-form').forEach(form => {
    form.addEventListener('submit', function (e) {
      if (!isLoggedIn) {
        e.preventDefault();
        alert('Please login to save to wishlist');
      }
    });
  });
</script>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
